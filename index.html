<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Skill Gap & Learning Management Portal</title>
    <style>
        :root {
            --bg: #f4f5f9;
            --card-bg: #ffffff;
            --text: #000000;
            --text-light: #444444;
            --nav-bg: #ffffff;
            --nav-btn-bg: #e7e9f0;
            --nav-btn-active: #005fff;
            --nav-btn-active-text: #ffffff;
            --header-bg: #005fff;
            --header-text: #ffffff;
            --button-bg: #005fff;
            --button-hover: #0045cc;
            --border-color: #ddd;
        }
        .dark-mode {
            --bg: #1c1f24;
            --card-bg: #2a2d33;
            --text: #e8e8e8;
            --text-light: #bbbbbb;
            --nav-bg: #1f2227;
            --nav-btn-bg: #31343a;
            --nav-btn-active: #007bff;
            --nav-btn-active-text: #ffffff;
            --header-bg: #0d47a1;
            --header-text: #ffffff;
            --button-bg: #007bff;
            --button-hover: #0056c7;
            --border-color: #3a3d42;
        }
        body {
            margin: 0;
            padding: 0;
            font-family: "Segoe UI", Arial, sans-serif;
            background: #f0f2f5;
        }
        .header {
            background: linear-gradient(135deg, #0048ff, #0099ff);
            padding: 20px;
            color: white;
            text-align: center;
            font-size: 20px;
            font-weight: 600;
        }
        .toggle-bar {
            text-align: center;
            padding: 10px;
            background: #ffffff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.06);
        }
        .toggle-bar button {
            margin: 0 5px;
            padding: 8px 14px;
            border-radius: 999px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
        }
        .toggle-active {
            background: #006aff;
            color: white;
        }
        .toggle-inactive {
            background: #e5e7eb;
            color: #333;
        }
        .container {
            max-width: 1000px;
            margin: 20px auto 40px auto;
            padding: 0 10px;
        }
        .card {
            background: white;
            padding: 18px;
            border-radius: 14px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
            margin-bottom: 18px;
        }
        .section-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        label {
            font-size: 13px;
            font-weight: 600;
            margin-top: 8px;
            display: block;
        }
        select, input {
            width: 100%;
            padding: 9px;
            margin-top: 4px;
            border-radius: 8px;
            border: 1px solid #dce0e5;
            font-size: 13px;
        }
        button.primary {
            width: 100%;
            margin-top: 12px;
            padding: 10px;
            border-radius: 8px;
            border: none;
            background: #006aff;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }
        button.inline {
            margin-top: 8px;
            margin-right: 8px;
            padding: 8px 10px;
            border-radius: 8px;
            border: none;
            background: #006aff;
            color: white;
            font-weight: 600;
            cursor: pointer;
            font-size: 12px;
        }
        .result-box {
            margin-top: 10px;
            padding: 10px;
            background: #fafafa;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            font-size: 13px;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0073e6;
            border-radius: 50%;
            width: 26px;
            height: 26px;
            animation: spin 0.8s linear infinite;
            margin: 10px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .progress-bar-container {
            margin-top: 8px;
            background: #e5e7eb;
            border-radius: 999px;
            overflow: hidden;
            height: 14px;
        }
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #00c853, #00e676);
            width: 0;
            transition: width 0.8s ease;
        }
        .course-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
            gap: 10px;
            margin-top: 8px;
        }
        .course-card {
            background: white;
            border-radius: 10px;
            padding: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.06);
            border-left: 3px solid #006aff;
        }
        .course-card h3 {
            margin: 0 0 4px 0;
            font-size: 13px;
            color: #0050cc;
        }
        .course-card a {
            display: inline-block;
            margin-top: 4px;
            font-size: 12px;
            color: #006aff;
            text-decoration: none;
            font-weight: 600;
        }
        .history-entry, .request-entry, .assignment-entry, .expiry-entry {
            padding: 8px;
            margin-bottom: 6px;
            border-radius: 8px;
            background: #f4f7ff;
            font-size: 12px;
        }
        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 999px;
            font-size: 11px;
            margin-left: 4px;
        }
        .badge-pending { background: #fff3cd; color: #856404; }
        .badge-approved { background: #d4edda; color: #155724; }
        .badge-assigned { background: #cce5ff; color: #004085; }
        .hidden { display: none; }
        .history-entry, .request-entry, .expiry-entry, .assignment-entry {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
        }
    </style>
</head>

<body>
    <div class="header">
        AI Skill Gap & Learning Management Portal
        <button class="theme-toggle" onclick="toggleTheme()">ðŸŒ“</button>
    </div>
    <div class="toggle-bar">
        <button id="btnEmployeeView" class="toggle-active" onclick="setView('employee')">Employee View</button>
        <button id="btnManagerView" class="toggle-inactive" onclick="setView('manager')">Manager View</button>
    </div>
    <div class="container">
        <!-- EMPLOYEE VIEW -->
        <div id="employeeView" style="flex:1;">
            <div class="card">
                <div class="section-title">1. Employee & Role Selection</div>
                <label>Select Employee</label>
                <select id="employeeId" onchange="showEmployeeProfile()">
                    <option value="">Loading employees...</option>
                </select>
                <label>Select Target Role</label>
                <select id="roleId">
                    <option value="">Loading roles...</option>
                </select>
                <button class="primary" onclick="checkSkillGap()">Analyse Skill Gap</button>
                <div id="employeeProfile" class="result-box">
                    <strong>Employee Profile</strong><br>
                    <span id="empProfileContent">Select an employee to view details.</span>
                </div>
            </div>
            <div class="card">
                <div class="section-title">2. Skill Gap Analysis</div>
                <div id="output"></div>
            </div>
            <div class="card">
                <div class="section-title">3. Skill Gap History</div>
                <button class="inline" onclick="loadHistory()">View Recent History</button>
                <div id="historyOutput" class="result-box"></div>
            </div>
            <div class="card">
                <div class="section-title">4. Request Addition of Learned Skill</div>
                <label>Employee (for skill request)</label>
                <select id="skillReqEmployee">
                    <option value="">Loading employees...</option>
                </select>
                <label>Skill Name</label>
                <input id="reqSkillName" placeholder="e.g. AWS">
                <label>Certification Name (optional)</label>
                <input id="reqCertName" placeholder="e.g. AWS Cloud Practitioner">
                <label>Certification Expiry Date (YYYY-MM-DD, optional)</label>
                <input id="reqExpiryDate" placeholder="2027-01-01">
                <button class="primary" onclick="requestSkill()">Submit Skill Request (Goes to Manager)</button>
                <div id="skillReqResult" class="result-box"></div>
            </div>
        </div>
        <!-- MANAGER VIEW -->
        <div id="managerView" class="hidden" style="flex:1;">
            <div class="card">
                <div class="section-title">1. Pending Skill Approval Requests</div>
                <button class="inline" onclick="loadPendingRequests()">Refresh Pending Requests</button>
                <div id="pendingRequestsBox" class="result-box"></div>
            </div>
            <div class="card"></div>
                <div class="section-title">2. Skills Needing Revalidation (Expiring Certifications)</div>
                <button class="inline" onclick="loadExpiringSkills()">Load Expiring Skills</button>
                <div id="expiringSkillsBox" class="result-box"></div>
            </div>
            <div class="card">
                <div class="section-title">3. Assign Learning to Team</div>
                <label>Select Employee</label>
                <select id="assignEmployee">
                    <option value="">Loading employees...</option>
                </select>
                <label>Target Skill</label>
                <input id="assignSkillName" placeholder="e.g. Microservices">
                <label>Course Name</label>
                <input id="assignCourseName" placeholder="e.g. Microservices Bootcamp">
                <label>Due Date (YYYY-MM-DD, optional)</label>
                <input id="assignDueDate" placeholder="2026-03-01">
                <button class="primary" onclick="assignLearning()">Assign Learning</button>
                <div id="assignResultBox" class="result-box"></div>
            </div>
            <div class="card">
                <div class="section-title">4. Team Learning Assignments</div>
                <button class="inline" onclick="loadAssignments()">Refresh Assignments</button>
                <div id="assignmentsBox" class="result-box"></div>
            </div>
        </div>
    </div>
    <script>
        const API_BASE = "https://dx87uzkcm2.execute-api.us-east-1.amazonaws.com";
        let employeesList = [];
        let rolesList = [];

        function setView(view) {
            const empView = document.getElementById("employeeView");
            const mgrView = document.getElementById("managerView");
            const btnEmp = document.getElementById("btnEmployeeView");
            const btnMgr = document.getElementById("btnManagerView");
            if (view === "employee") {
                empView.classList.remove("hidden");
                mgrView.classList.add("hidden");
                btnEmp.classList.add("toggle-active");
                btnEmp.classList.remove("toggle-inactive");
                btnMgr.classList.add("toggle-inactive");
                btnMgr.classList.remove("toggle-active");
            } else {
                empView.classList.add("hidden");
                mgrView.classList.remove("hidden");
                btnEmp.classList.add("toggle-inactive");
                btnEmp.classList.remove("toggle-active");
                btnMgr.classList.add("toggle-active");
                btnMgr.classList.remove("toggle-inactive");
            }
        }

        async function loadEmployees() {
            const selEmp = document.getElementById("employeeId");
            const selSkillReq = document.getElementById("skillReqEmployee");
            const selAssignEmp = document.getElementById("assignEmployee");
            selEmp.innerHTML = `<option>Loading employees...</option>`;
            selSkillReq.innerHTML = `<option>Loading employees...</option>`;
            selAssignEmp.innerHTML = `<option>Loading employees...</option>`;
            try {
                const res = await fetch(`${API_BASE}/employees`);
                const list = await res.json();
                employeesList = list;
                if (!Array.isArray(list) || !list.length) {
                    selEmp.innerHTML = `<option value="">No employees found</option>`;
                    selSkillReq.innerHTML = `<option value="">No employees found</option>`;
                    selAssignEmp.innerHTML = `<option value="">No employees found</option>`;
                    return;
                }
                selEmp.innerHTML = `<option value="">-- Select Employee --</option>`;
                selSkillReq.innerHTML = `<option value="">-- Select Employee --</option>`;
                selAssignEmp.innerHTML = `<option value="">-- Select Employee --</option>`;
                list.forEach(emp => {
                    const text = `${emp.employeeId} - ${emp.name}`;
                    selEmp.innerHTML += `<option value="${emp.employeeId}">${text}</option>`;
                    selSkillReq.innerHTML += `<option value="${emp.employeeId}">${text}</option>`;
                    selAssignEmp.innerHTML += `<option value="${emp.employeeId}">${text}</option>`;
                });
            } catch (e) {
                selEmp.innerHTML = `<option value="">Error loading employees</option>`;
                selSkillReq.innerHTML = `<option value="">Error loading employees</option>`;
                selAssignEmp.innerHTML = `<option value="">Error loading employees</option>`;
            }
        }

        async function loadRoles() {
            const sel = document.getElementById("roleId");
            sel.innerHTML = `<option>Loading roles...</option>`;
            try {
                const res = await fetch(`${API_BASE}/roles`);
                const list = await res.json();
                rolesList = list;
                if (!Array.isArray(list) || !list.length) {
                    sel.innerHTML = `<option value="">No roles found</option>`;
                    return;
                }
                sel.innerHTML = `<option value="">-- Select Role --</option>`;
                list.forEach(role => {
                    sel.innerHTML += `<option value="${role.roleId}">${role.roleId} - ${role.roleName}</option>`;
                });
            } catch (e) {
                sel.innerHTML = `<option value="">Error loading roles</option>`;
            }
        }

        function showEmployeeProfile() {
            const empId = document.getElementById("employeeId").value;
            const profileDiv = document.getElementById("empProfileContent");
            if (!empId) {
                profileDiv.innerHTML = "Select an employee to view details.";
                return;
            }
            const emp = employeesList.find(e => e.employeeId === empId);
            if (!emp) {
                profileDiv.innerHTML = "Employee details not found.";
                return;
            }
            const skills = emp.skills || [];
            const certs = emp.certifications || [];
            profileDiv.innerHTML = `
                <strong>Name:</strong> ${emp.name}<br>
                <strong>Current Role:</strong> ${emp.currentRole || "N/A"}<br>
                <strong>Skills:</strong> ${skills.length ? skills.join(", ") : "No skills recorded"}<br>
                <strong>Certifications:</strong><br>
                ${
                    certs.length
                        ? certs.map(c => `
                            <span>- ${c.skill || ""} (${c.certificationName || "No cert"}) ${c.expiryDate ? "(Expiry: " + c.expiryDate + ")" : ""}</span><br>
                        `).join("")
                        : "No certifications recorded"
                }
            `;
        }

        async function checkSkillGap() {
            const out = document.getElementById("output");
            out.innerHTML = `<div class="loader"></div><p style="text-align:center;">Analyzing...</p>`;
            const employeeId = document.getElementById("employeeId").value;
            const roleId = document.getElementById("roleId").value;
            if (!employeeId || !roleId) {
                out.innerHTML = `<p style="color:red;">Please select both Employee and Role.</p>`;
                return;
            }
            try {
                const res = await fetch(`${API_BASE}/skill-gap`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ employeeId, roleId })
                });
                const data = await res.json();
                const matched = data.matchedSkills || [];
                const missing = data.missingSkills || [];
                const percent = data.matchPercent || 0;
                out.innerHTML = `
                    <div class="result-box">
                        <p><strong>Employee:</strong> ${data.employeeName || employeeId}</p>
                        <p><strong>Role:</strong> ${data.roleName || roleId}</p>
                        <p><strong>Match:</strong> ${percent}% (${matched.length} / ${(matched.length + missing.length) || matched.length} skills)</p>
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill" id="progressBarFill"></div>
                        </div>
                        <br>
                        <strong>Matched Skills:</strong><br>
                        ${matched.length ? matched.join(", ") : "None"}<br><br>
                        <strong>Missing Skills:</strong><br>
                        ${missing.length ? missing.join(", ") : "None"}<br><br>
                        <strong>Recommended Courses:</strong>
                        ${
                            data.recommendedCourses && data.recommendedCourses.length
                                ? `
                                    <div class="course-grid">
                                        ${data.recommendedCourses.map(c => `
                                            <div class="course-card">
                                                <h3>${c.skill}</h3>
                                                <p>${c.courseName}</p>
                                                <a href="${c.courseLink}" target="_blank">View Course â†’</a>
                                            </div>
                                        `).join("")}
                                    </div>
                                `
                                : "<br>No recommendations."
                        }
                    </div>
                `;
                setTimeout(() => {
                    const bar = document.getElementById("progressBarFill");
                    if (bar) bar.style.width = Math.max(0, Math.min(100, percent)) + "%";
                }, 100);
            } catch (e) {
                out.innerHTML = `<p style="color:red;">Error calling API.</p>`;
            }
        }

        async function loadHistory() {
            const box = document.getElementById("historyOutput");
            const employeeId = document.getElementById("employeeId").value;
            const roleId = document.getElementById("roleId").value;
            if (!employeeId) {
                box.innerHTML = `<p style="color:red;">Select an employee to view history.</p>`;
                return;
            }
            box.innerHTML = `<div class="loader"></div><p style="text-align:center;">Loading history...</p>`;
            try {
                const res = await fetch(`${API_BASE}/history`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ employeeId, roleId })
                });
                const data = await res.json();
                if (!Array.isArray(data) || !data.length) {
                    box.innerHTML = `<p>No history found.</p>`;
                    return;
                }
                box.innerHTML = data.map(h => `
                    <div class="history-entry">
                        <strong>Role:</strong> ${h.roleId}<br>
                        <strong>Match:</strong> ${h.matchPercent || 0}%<br>
                        <strong>Missing:</strong> ${(h.missingSkills || []).join(", ") || "None"}<br>
                        <small>${h.timestamp}</small>
                    </div>
                `).join("");
            } catch (e) {
                box.innerHTML = `<p style="color:red;">Error loading history.</p>`;
            }
        }

        async function requestSkill() {
            const empId = document.getElementById("skillReqEmployee").value;
            const skillName = document.getElementById("reqSkillName").value.trim();
            const certName = document.getElementById("reqCertName").value.trim();
            const expiryDate = document.getElementById("reqExpiryDate").value.trim();
            const box = document.getElementById("skillReqResult");
            if (!empId || !skillName) {
                box.innerHTML = `<p style="color:red;">Employee and Skill Name are required.</p>`;
                return;
            }
            box.innerHTML = `<div class="loader"></div><p style="text-align:center;">Submitting request...</p>`;
            try {
                const res = await fetch(`${API_BASE}/request-skill`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        employeeId: empId,
                        skillName,
                        certificationName: certName,
                        expiryDate
                    })
                });
                const data = await res.json();
                if (res.status === 200) {
                    box.innerHTML = `<p style="color:green;">Request submitted successfully. Awaiting manager approval.</p>`;
                } else {
                    box.innerHTML = `<p style="color:red;">Error: ${data.message}</p>`;
                }
            } catch (e) {
                box.innerHTML = `<p style="color:red;">Error calling API.</p>`;
            }
        }

        async function loadPendingRequests() {
            const box = document.getElementById("pendingRequestsBox");
            box.innerHTML = `<div class="loader"></div><p style="text-align:center;">Loading pending requests...</p>`;
            try {
                const res = await fetch(`${API_BASE}/pending-requests`);
                const data = await res.json();
                if (!Array.isArray(data) || !data.length) {
                    box.innerHTML = `<p>No pending requests.</p>`;
                    return;
                }
                box.innerHTML = data.map(r => `
                    <div class="request-entry">
                        <strong>${r.employeeId}</strong> requested skill <strong>${r.skillName}</strong>
                        <span class="badge badge-pending">PENDING</span><br>
                        Certification: ${r.certificationName || "N/A"}<br>
                        Expiry: ${r.expiryDate || "N/A"}<br>
                        Requested At: ${r.requestedAt}<br>
                        <button class="inline" onclick="approveSkill('${r.requestId}', 'APPROVE')">Approve</button>
                        <button class="inline" style="background:#dc3545;" onclick="approveSkill('${r.requestId}', 'REJECT')">Reject</button>
                    </div>
                `).join("");
            } catch (e) {
                box.innerHTML = `<p style="color:red;">Error loading pending requests.</p>`;
            }
        }

        async function approveSkill(requestId, action) {
            const box = document.getElementById("pendingRequestsBox");
            try {
                const res = await fetch(`${API_BASE}/approve-skill`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ requestId, action, managerId: "MANAGER1" })
                });
                const data = await res.json();
                if (res.status === 200) {
                    box.innerHTML = `<p style="color:green;">${data.message}</p>`;
                    await loadEmployees();
                } else {
                    box.innerHTML = `<p style="color:red;">Error: ${data.message}</p>`;
                }
            } catch (e) {
                box.innerHTML = `<p style="color:red;">Error calling API.</p>`;
            }
        }

        async function loadExpiringSkills() {
            const box = document.getElementById("expiringSkillsBox");
            box.innerHTML = `<div class="loader"></div><p style="text-align:center;">Checking expiring skills...</p>`;
            try {
                const res = await fetch(`${API_BASE}/expiring-skills`);
                const data = await res.json();
                if (!Array.isArray(data) || !data.length) {
                    box.innerHTML = `<p>No certifications expiring in the next 90 days.</p>`;
                    return;
                }
                box.innerHTML = data.map(e => `
                    <div class="expiry-entry">
                        <strong>${e.employeeName} (${e.employeeId})</strong><br>
                        Skill: ${e.skill}<br>
                        Certification: ${e.certificationName}<br>
                        Expiry Date: ${e.expiryDate}
                    </div>
                `).join("");
            } catch (err) {
                box.innerHTML = `<p style="color:red;">Error loading expiring skills.</p>`;
            }
        }

        async function assignLearning() {
            const empId = document.getElementById("assignEmployee").value;
            const skillName = document.getElementById("assignSkillName").value.trim();
            const courseName = document.getElementById("assignCourseName").value.trim();
            const dueDate = document.getElementById("assignDueDate").value.trim();
            const box = document.getElementById("assignResultBox");
            if (!empId || !skillName || !courseName) {
                box.innerHTML = `<p style="color:red;">Employee, Skill, and Course Name are required.</p>`;
                return;
            }
            box.innerHTML = `<div class="loader"></div><p style="text-align:center;">Assigning learning...</p>`;
            try {
                const res = await fetch(`${API_BASE}/assign-learning`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        employeeId: empId,
                        skillName,
                        courseName,
                        dueDate,
                        managerId: "MANAGER1"
                    })
                });
                const data = await res.json();
                if (res.status === 200) {
                    box.innerHTML = `<p style="color:green;">Learning assigned successfully.</p>`;
                } else {
                    box.innerHTML = `<p style="color:red;">Error: ${data.message}</p>`;
                }
            } catch (e) {
                box.innerHTML = `<p style="color:red;">Error calling API.</p>`;
            }
        }

        async function loadAssignments() {
            const box = document.getElementById("assignmentsBox");
            box.innerHTML = `<div class="loader"></div><p style="text-align:center;">Loading assignments...</p>`;
            try {
                const res = await fetch(`${API_BASE}/assignments`);
                const data = await res.json();
                if (!Array.isArray(data) || !data.length) {
                    box.innerHTML = `<p>No assignments found.</p>`;
                    return;
                }
                box.innerHTML = data.map(a => `
                    <div class="assignment-entry">
                        <strong>${a.employeeId}</strong> â†’ ${a.skillName}<br>
                        Course: ${a.courseName}<br>
                        Due: ${a.dueDate || "N/A"}<br>
                        Status: <span class="badge badge-assigned">${a.status}</span><br>
                        Assigned At: ${a.createdAt} by ${a.createdBy}
                    </div>
                `).join("");
            } catch (e) {
                box.innerHTML = `<p style="color:red;">Error loading assignments.</p>`;
            }
        }

        function toggleTheme() {
            document.body.classList.toggle("dark-mode");
            if (document.body.classList.contains("dark-mode")) {
                localStorage.setItem("theme", "dark");
            } else {
                localStorage.setItem("theme", "light");
            }
        }

        window.onload = () => {
            const saved = localStorage.getItem("theme");
            if (saved === "dark") {
                document.body.classList.add("dark-mode");
            }
            loadEmployees();
            loadRoles();
        };
    </script>
</body>

</html>